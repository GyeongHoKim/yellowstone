{"version":3,"file":"util.js","sourceRoot":"","sources":["../lib/util.ts"],"names":[],"mappings":"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","sourcesContent":["import { createHash } from \"crypto\";\r\n\r\nexport interface RTPPacket {\r\n  id: number;\r\n  timestamp: number;\r\n  marker: number;\r\n  padding: number;\r\n  hasExtensions: number;\r\n\r\n  payload: Buffer;\r\n\r\n  length: number;\r\n  paddingLength: number;\r\n\r\n  payloadType: number;\r\n\r\n  // Additional information added to the Packet\r\n  wallclockTime?: Date;\r\n}\r\n\r\nexport function parseRTPPacket(buffer: Buffer): RTPPacket {\r\n  const padding = (buffer[0] >> 5) & 0x01\r\n  let paddingLength = 0;\r\n  if (padding == 1) {\r\n    // padding size is the last byte of the RTP data\r\n    paddingLength = buffer[buffer.length - 1];\r\n  }\r\n  const hasExtensions = (buffer[0] >> 4) & 0x01;\r\n  const marker = (buffer[1]) >>> 7;\r\n  const payloadType = buffer[1] & 0x7f;\r\n  const num_csrc_identifiers = (buffer[0] & 0x0F);\r\n\r\n  const payload = buffer.slice((num_csrc_identifiers * 4) + (hasExtensions ? 16 : 12)); // includes padding\r\n  const length = payload.length;\r\n\r\n\r\n  return {\r\n    id: buffer.readUInt16BE(2),\r\n    timestamp: buffer.readUInt32BE(4),\r\n    marker,\r\n    padding,\r\n    payloadType,\r\n    hasExtensions,\r\n    payload,\r\n    length,\r\n    paddingLength,\r\n  };\r\n}\r\n\r\nexport interface SenderReport {\r\n  ntpTimestampMSW: number;\r\n  ntpTimestampLSW: number;\r\n  rtpTimestamp: number;\r\n  senderPacketCount: number;\r\n  senderOctetCount: number;\r\n}\r\n\r\nexport interface RTCPPacket {\r\n  buffer: Buffer;\r\n  version: number;\r\n  padding: number;\r\n  receptionReportCount: number;\r\n  packetType: number;\r\n  length: number;\r\n  ssrc: number;\r\n\r\n  senderReport?: SenderReport;\r\n}\r\n\r\nexport function parseRTCPPacket(buffer: Buffer): RTCPPacket {\r\n\r\n  // Packet Types\r\n  // SR         Sender Report                200\r\n  // RR         Receiver Report              201\r\n  // SDES       Source Description           202\r\n  // BYE        Goodbye                      203\r\n  // APP        Application-Defined          204\r\n  // RTPFB      Generic RTP feedback         205\r\n  // PSFB       Payload-specific feedback    206\r\n  // XR         RTCP Extension               207\r\n  const version = (buffer[0] >> 6);\r\n  const padding = (buffer[0] >> 5) & 0x01;\r\n  const receptionReportCount = (buffer[0]) & 0x1F;\r\n  const packetType = buffer[1];\r\n  const length = buffer[2] << 8 + buffer[3]; // The length in 32 bit words (not the length in bytes)\r\n  const ssrc = buffer[4] << 24 + buffer[5] << 16 + buffer[6] << 8 + buffer[7];\r\n\r\n  let result: RTCPPacket = {\r\n    buffer,\r\n    version,\r\n    padding,\r\n    length,\r\n    ssrc,\r\n    receptionReportCount,\r\n    packetType};\r\n\r\n  if (packetType == 200) {\r\n    let senderReport: SenderReport = {\r\n      ntpTimestampMSW: buffer.readUInt32BE(8),\r\n      ntpTimestampLSW: buffer.readUInt32BE(12),\r\n      rtpTimestamp: buffer.readUInt32BE(16),\r\n      senderPacketCount: buffer.readUInt32BE(20),\r\n      senderOctetCount: buffer.readUInt32BE(24)\r\n    };\r\n\r\n    result.senderReport = senderReport;\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n// utility function for using crypto library\r\nexport function getMD5Hash(str: string): string {\r\n  const md5 = createHash(\"md5\");\r\n  md5.update(str);\r\n\r\n  return md5.digest(\"hex\");\r\n}\r\n\r\nexport function getSHA256Hash(str: string): string {\r\n  const sha256 = createHash(\"sha256\"); // use getHashes() to see what is supported\r\n  sha256.update(str);\r\n\r\n  return sha256.digest(\"hex\");\r\n}\r\n\r\nexport interface Transport {\r\n  protocol: string;\r\n  parameters: { [key: string]: string };\r\n}\r\n\r\nexport function parseTransport(transport: string): Transport {\r\n  const parameters: { [key: string]: string } = {};\r\n\r\n  const parts = transport.split(\";\");\r\n  const protocol = parts[0];\r\n\r\n  for (let i = 0; i < parts.length; i++) {\r\n    const part = parts[i];\r\n    const index = part.indexOf(\"=\");\r\n\r\n    if (index > -1 && index !== part.length - 1) {\r\n      parameters[part.substring(0, index)] = part.substring(index + 1);\r\n    }\r\n  }\r\n\r\n  return {\r\n    protocol,\r\n    parameters\r\n  };\r\n}\r\n\r\nexport function randInclusive(min: number, max: number): number {\r\n  min = Math.ceil(min);\r\n  max = Math.floor(max);\r\n  return Math.floor(Math.random() * (max - min + 1)) + min;\r\n}\r\n\r\nexport function generateSSRC(): number {\r\n  return randInclusive(1, 0xffffffff);\r\n}\r\n\r\n// BitStream classes by 2018 Roger Hardiman, RJH Technical Consultancy Ltd\r\n// Write to a bitstream and read back as an array\r\n\r\nexport class BitStream {\r\n\r\n  data: number[] = []; // Array only stores 0 or 1 (one 'bit' per buffer item)\r\n  // not very efficient on memory\r\n\r\n  // Constructor\r\n  // constructor() {}\r\n  \r\n  // Functions\r\n  AddValue(value: number, num_bits: number): void {\r\n    // Add each bit to the List\r\n    for (let i = num_bits - 1; i >= 0; i--) {\r\n      this.data.push((value >> i) & 0x01);\r\n    }\r\n  }\r\n\r\n  AddHexString(hex_string: string): void {\r\n    const hex_chars = hex_string.toUpperCase();\r\n\r\n    for (let x = 0; x < hex_chars.length; x++) {\r\n      const c = hex_chars.charAt(x);\r\n      if (c == '0') this.AddValue(0, 4);\r\n      else if (c == '1') this.AddValue(1, 4);\r\n      else if (c == '2') this.AddValue(2, 4);\r\n      else if (c == '3') this.AddValue(3, 4);\r\n      else if (c == '4') this.AddValue(4, 4);\r\n      else if (c == '5') this.AddValue(5, 4);\r\n      else if (c == '6') this.AddValue(6, 4);\r\n      else if (c == '7') this.AddValue(7, 4);\r\n      else if (c == '8') this.AddValue(8, 4);\r\n      else if (c == '9') this.AddValue(9, 4);\r\n      else if (c == 'A') this.AddValue(10, 4);\r\n      else if (c == 'B') this.AddValue(11, 4);\r\n      else if (c == 'C') this.AddValue(12, 4);\r\n      else if (c == 'D') this.AddValue(13, 4);\r\n      else if (c == 'E') this.AddValue(14, 4);\r\n      else if (c == 'F') this.AddValue(15, 4);\r\n    }\r\n  }\r\n\r\n  Read(num_bits: number): number {\r\n    // Read and remove items from the front of the list of bits\r\n    if (this.data.length < num_bits) return 0;\r\n    let result = 0;\r\n    for (let i = 0; i < num_bits; i++) {\r\n      result = result << 1;\r\n      result = result + this.data[0];\r\n      this.data.shift(); // remove the first item from the array\r\n    }\r\n    return result;\r\n  }\r\n\r\n  ToArray(): Buffer {\r\n    const num_bytes = Math.ceil(this.data.length / 8.0);\r\n    const array = Buffer.alloc(num_bytes);\r\n    let ptr = 0;\r\n    let shift = 7;\r\n    for (let i = 0; i < this.data.length; i++) {\r\n      array[ptr] += (this.data[i] << shift);\r\n      if (shift == 0) {\r\n        shift = 7;\r\n        ptr++;\r\n      }\r\n      else {\r\n        shift--;\r\n      }\r\n    }\r\n\r\n    return array;\r\n  }\r\n}\r\n"]}